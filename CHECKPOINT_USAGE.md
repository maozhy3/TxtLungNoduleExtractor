# 检查点功能使用说明

## 功能概述

已为 `core.py` 添加了周期性保存和崩溃恢复功能，支持：
- ✅ 自动周期性保存进度
- ✅ 程序崩溃后从上次保存点继续运行
- ✅ 手动中断（Ctrl+C）后保存进度
- ✅ 支持单进程和多进程模式

## 配置说明

在 `config.py` 中添加了新的配置项：

```python
CHECKPOINT_SAVE_INTERVAL = 10  # 每处理多少条数据保存一次检查点
```

建议值：
- 数据量小（<100条）：设置为 5-10
- 数据量中等（100-1000条）：设置为 10-20
- 数据量大（>1000条）：设置为 20-50

## 工作原理

### 1. 自动保存
程序每处理 N 条数据（由 `CHECKPOINT_SAVE_INTERVAL` 配置）会自动保存一次检查点，包含：
- 已完成的预测结果
- 已处理的数据索引
- 累计耗时
- 保存时间戳

### 2. 断点续传
当程序再次运行时：
- 自动检测是否存在检查点文件
- 如果存在，从上次中断的位置继续处理
- 跳过已处理的数据，只处理剩余部分

### 3. 异常处理
- **手动中断（Ctrl+C）**：捕获信号，保存检查点后退出
- **程序崩溃**：在异常发生时自动保存检查点
- **正常完成**：自动清除检查点文件

## 使用示例

### 正常运行
```bash
python main.py
```

如果是首次运行，会显示：
```
开始新的预测任务（共 100 条）
```

如果检测到检查点，会显示：
```
✓ 检测到检查点，已完成 45/100 条，继续处理剩余 55 条
```

### 查看检查点状态
```bash
python test_checkpoint.py
```

输出示例：
```
当前检查点状态：
============================================================
模型: qwen-medical-lora-251106-f16
  已处理: 45 条
  累计耗时: 123.45s
  保存时间: 2025-11-10 14:30:25
------------------------------------------------------------
```

### 清除所有检查点
```bash
python test_checkpoint.py clear
```

## 检查点文件位置

检查点文件保存在 `checkpoints/` 目录下：
```
checkpoints/
  └── {模型名称}_checkpoint.pkl
```

## 注意事项

1. **磁盘空间**：检查点文件大小取决于数据量，通常很小（几KB到几MB）

2. **数据一致性**：如果修改了输入数据文件，建议清除旧的检查点：
   ```bash
   python test_checkpoint.py clear
   ```

3. **多模型支持**：每个模型有独立的检查点文件，互不影响

4. **性能影响**：保存检查点的开销很小，通常不到 0.1 秒

## 故障恢复场景

### 场景1：程序意外崩溃
```
处理到第 45 条时程序崩溃
→ 检查点已保存（最近一次是第 40 条）
→ 重新运行 python main.py
→ 从第 41 条继续处理
```

### 场景2：手动中断
```
按 Ctrl+C 中断程序
→ 捕获中断信号，保存检查点
→ 重新运行 python main.py
→ 从上次中断位置继续
```

### 场景3：电脑断电/重启
```
处理过程中电脑断电
→ 最后一次自动保存的检查点仍然有效
→ 重启后运行 python main.py
→ 从最后保存点继续（可能丢失最多 CHECKPOINT_SAVE_INTERVAL 条数据的进度）
```

## 高级用法

### 手动管理检查点

```python
from core import CheckpointManager

# 创建管理器
manager = CheckpointManager(save_interval=5)

# 加载检查点
checkpoint = manager.load_checkpoint("model_name")
if checkpoint:
    print(f"已处理: {len(checkpoint['processed_indices'])} 条")

# 清除检查点
manager.clear_checkpoint("model_name")
```

## 常见问题

**Q: 检查点会影响性能吗？**  
A: 影响很小，每次保存只需要 0.01-0.1 秒。

**Q: 可以在不同电脑上继续运行吗？**  
A: 可以，只需复制整个项目目录（包括 checkpoints 文件夹）。

**Q: 如何强制重新开始？**  
A: 运行 `python test_checkpoint.py clear` 清除检查点。

**Q: 检查点文件可以删除吗？**  
A: 可以，删除后会从头开始处理。
